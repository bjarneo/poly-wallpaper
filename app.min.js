const canvas=document.getElementById("canvas");const gl=canvas.getContext("webgl");const cfg={grid:60,bright:1,sat:1.2,edge:.3};let mesh=null,imgData=null,edgePoints=[];function showPlaceholder(){const ctx=canvas.getContext("2d");ctx.fillStyle="#0f172a";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="rgba(255, 255, 255, 0.3)";ctx.font="24px Inter, sans-serif";ctx.textAlign="center";ctx.fillText("Upload an image to begin",canvas.width/2,canvas.height/2)}async function detectEdges(imageData){const status=document.getElementById("status");status.innerHTML='<svg style="width:14px;height:14px;animation:spin 1s linear infinite" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg> AI analyzing...';const tensor=tf.browser.fromPixels(imageData).toFloat().div(255);const gray=tensor.mean(2).expandDims(2);const sobelX=tf.tensor2d([[-1,0,1],[-2,0,2],[-1,0,1]]).expandDims(2).expandDims(3);const sobelY=tf.tensor2d([[-1,-2,-1],[0,0,0],[1,2,1]]).expandDims(2).expandDims(3);const grayBatch=gray.expandDims(0);const edgesX=tf.conv2d(grayBatch,sobelX,1,"same");const edgesY=tf.conv2d(grayBatch,sobelY,1,"same");const magnitude=tf.sqrt(tf.add(tf.square(edgesX),tf.square(edgesY))).squeeze();const edgeData=await magnitude.data();const width=imageData.width,height=imageData.height;const threshold=cfg.edge;const edges=[];for(let y=2;y<height-2;y+=2){for(let x=2;x<width-2;x+=2){const val=edgeData[y*width+x];if(val>threshold){edges.push({x:x/width,y:y/height,strength:val})}}}tensor.dispose();gray.dispose();sobelX.dispose();sobelY.dispose();grayBatch.dispose();edgesX.dispose();edgesY.dispose();magnitude.dispose();status.innerHTML=`<svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Detected ${edges.length} edges`;return edges.sort((a,b)=>b.strength-a.strength)}function sampleImg(x,y){if(!imgData)return[0,0,0];const px=Math.floor(x*(imgData.width-1)),py=Math.floor(y*(imgData.height-1));if(px<0||px>=imgData.width||py<0||py>=imgData.height)return[0,0,0];const i=(py*imgData.width+px)*4;return[imgData.data[i],imgData.data[i+1],imgData.data[i+2]]}const vs=`attribute vec2 p;attribute vec3 c;varying vec3 vc;uniform vec2 r;void main(){vec2 pos=p/r*2.0-1.0;pos.y=-pos.y;gl_Position=vec4(pos,0,1);vc=c;}`;const fs=`precision mediump float;varying vec3 vc;uniform float b;uniform float s;vec3 adjSat(vec3 col,float sat){float g=dot(col,vec3(0.299,0.587,0.114));return mix(vec3(g),col,sat);}void main(){vec3 c=adjSat(vc,s)*b;gl_FragColor=vec4(c,1);}`;function shader(t,src){const sh=gl.createShader(t);gl.shaderSource(sh,src);gl.compileShader(sh);return sh}const prog=gl.createProgram();gl.attachShader(prog,shader(gl.VERTEX_SHADER,vs));gl.attachShader(prog,shader(gl.FRAGMENT_SHADER,fs));gl.linkProgram(prog);gl.useProgram(prog);const pLoc=gl.getAttribLocation(prog,"p"),cLoc=gl.getAttribLocation(prog,"c"),rLoc=gl.getUniformLocation(prog,"r"),bLoc=gl.getUniformLocation(prog,"b"),sLoc=gl.getUniformLocation(prog,"s");const pBuf=gl.createBuffer(),cBuf=gl.createBuffer();function resize(){canvas.width=innerWidth;canvas.height=innerHeight;gl.viewport(0,0,canvas.width,canvas.height)}function hsl(h,s,l){s/=100;l/=100;const k=n=>(n+h/30)%12,a=s*Math.min(l,1-l),f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));return[f(0)*255,f(8)*255,f(4)*255]}async function gen(){const w=canvas.width,h=canvas.height,cs=Math.max(w,h)/cfg.grid,cols=Math.ceil(w/cs)+1,rows=Math.ceil(h/cs)+1;const pts=[];for(let y=0;y<=rows;y++)for(let x=0;x<=cols;x++)pts.push({x:x*cs+(Math.random()-.5)*cs*.4,y:y*cs+(Math.random()-.5)*cs*.4});if(imgData){edgePoints=await detectEdges(imgData);const ec=Math.min(edgePoints.length,cfg.grid*3);for(let i=0;i<ec;i++){const e=edgePoints[i];pts.push({x:e.x*w+(Math.random()-.5)*cs*.3,y:e.y*h+(Math.random()-.5)*cs*.3,isEdge:true})}}const tris=[];for(let y=0;y<rows;y++)for(let x=0;x<cols;x++){const i=y*(cols+1)+x;tris.push([pts[i],pts[i+1],pts[i+cols+1]]);tris.push([pts[i+1],pts[i+cols+2],pts[i+cols+1]])}tris.forEach(t=>{const cx=(t[0].x+t[1].x+t[2].x)/3,cy=(t[0].y+t[1].y+t[2].y)/3,tx=cx/w,ty=cy/h;let c;if(imgData){c=sampleImg(tx,ty);c=c.map(v=>Math.min(255,v*1.1))}else{c=[100,100,100]}t.color=c.map(v=>v/255)});return tris}function draw(){if(!mesh)return;gl.clearColor(.06,.09,.16,1);gl.clear(gl.COLOR_BUFFER_BIT);const pos=[],col=[];mesh.forEach(t=>t.forEach(p=>{pos.push(p.x,p.y);col.push(...t.color)}));gl.bindBuffer(gl.ARRAY_BUFFER,pBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(pos),gl.STATIC_DRAW);gl.enableVertexAttribArray(pLoc);gl.vertexAttribPointer(pLoc,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,cBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(col),gl.STATIC_DRAW);gl.enableVertexAttribArray(cLoc);gl.vertexAttribPointer(cLoc,3,gl.FLOAT,false,0,0);gl.uniform2f(rLoc,canvas.width,canvas.height);gl.uniform1f(bLoc,cfg.bright);gl.uniform1f(sLoc,cfg.sat);gl.drawArrays(gl.TRIANGLES,0,pos.length/2)}async function regen(){if(!imgData){showPlaceholder();return}mesh=await gen();draw()}function down(w,h){const c=document.createElement("canvas");c.width=w;c.height=h;const ctx=c.getContext("2d");ctx.fillStyle="#0f172a";ctx.fillRect(0,0,w,h);const sx=w/canvas.width,sy=h/canvas.height;function applySat(r,g,b,sat){const gray=.299*r+.587*g+.114*b;return[Math.floor(Math.min(255,Math.max(0,gray+(r-gray)*sat))),Math.floor(Math.min(255,Math.max(0,gray+(g-gray)*sat))),Math.floor(Math.min(255,Math.max(0,gray+(b-gray)*sat)))]}mesh.forEach(t=>{ctx.beginPath();ctx.moveTo(t[0].x*sx,t[0].y*sy);ctx.lineTo(t[1].x*sx,t[1].y*sy);ctx.lineTo(t[2].x*sx,t[2].y*sy);ctx.closePath();let rgb=t.color.map(v=>v*255*cfg.bright);rgb=applySat(rgb[0],rgb[1],rgb[2],cfg.sat);ctx.fillStyle=`rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;ctx.fill()});c.toBlob(b=>{const u=URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download=`poly-${w}x${h}.png`;a.click();URL.revokeObjectURL(u)})}document.getElementById("grid").oninput=e=>{cfg.grid=parseInt(e.target.value);document.getElementById("gridVal").textContent=e.target.value;regen()};document.getElementById("bright").oninput=e=>{cfg.bright=parseFloat(e.target.value);document.getElementById("brightVal").textContent=e.target.value;draw()};document.getElementById("sat").oninput=e=>{cfg.sat=parseFloat(e.target.value);document.getElementById("satVal").textContent=e.target.value;draw()};document.getElementById("edge").oninput=e=>{cfg.edge=parseFloat(e.target.value);document.getElementById("edgeVal").textContent=e.target.value;if(imgData)regen()};document.getElementById("img").onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader;r.onload=ev=>{const img=new Image;img.onload=()=>{const c=document.createElement("canvas"),ctx=c.getContext("2d"),ms=600,sc=Math.min(ms/img.width,ms/img.height,1);c.width=img.width*sc;c.height=img.height*sc;ctx.drawImage(img,0,0,c.width,c.height);imgData=ctx.getImageData(0,0,c.width,c.height);regen()};img.src=ev.target.result};r.readAsDataURL(f)};function togglePanel(){const panel=document.getElementById("panel");const btn=document.getElementById("toggleBtn");panel.classList.toggle("collapsed");btn.classList.toggle("visible")}addEventListener("resize",()=>{resize();regen()});resize();showPlaceholder();